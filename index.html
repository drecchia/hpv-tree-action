<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tree Action Component</title>
    <link rel="stylesheet" href="./src/css/main.css">
    <style>
        body {
            font-family: sans-serif;
            margin: 20px;
        }
        .tree-action-button {
            margin-right: 5px;
        }
        .level-controls {
            display: flex;
            align-items: center;
        }
        .level-input {
            width: 60px;
            margin-right: 10px;
            padding: 5px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }
    </style>
</head>
<body>

    <h1>Tree Action Component Example</h1>

    <div id="tree-container">
        <!-- The tree component will be rendered here -->
    </div>

    <script src="./src/js/event-emitter.js"></script>
    <script src="./src/js/tree-node.js"></script>
    <script src="./src/js/tree-action.js"></script>
    <script>
        let treeAction;

        document.addEventListener('DOMContentLoaded', () => {
            // Sample initial data
            const initialTreeData = {
                operations: [
                    { code: 'C', tooltip: 'Create' },
                    { code: 'R', tooltip: 'Read' },
                    { code: 'Rc', tooltip: 'Read Cascade' },
                    { code: 'U', tooltip: 'Update' },
                    { code: 'D', tooltip: 'Delete' },
                    { code: 'S', tooltip: 'Share' },
                ],
                tree: {
                    id: 'root-domain',
                    name: '/',
                    isFolder: true,
                    level: 0,
                    operationState: {},
                    availableOperations: ['C', 'R', 'Rc', 'U', 'D', 'S'],
                    lazyLoad: false,
                    loaded: true,
                    children: [
                        {
                            id: 'monitrack-domain',
                            name: 'Monitrack',
                            isFolder: true,
                            level: 1,
                            operationState: { 'R': 'allowed' },
                            availableOperations: ['C', 'R', 'U', 'D'],
                            lazyLoad: false,
                            loaded: true,
                            children: [
                                {
                                    id: 'clientes-monitrack',
                                    name: 'Clientes',
                                    isFolder: true,
                                    level: 2,
                                    operationState: { 'R': 'allowed' },
                                    availableOperations: ['R'],
                                    lazyLoad: true,
                                    loaded: false,
                                    children: []
                                }
                            ]
                        },
                        {
                            id: 'vetrade-domain',
                            name: 'Vetrade',
                            isFolder: true,
                            level: 1,
                            operationState: { 'R': 'allowed', 'U': 'allowed' },
                            availableOperations: ['R', 'U'],
                            lazyLoad: false,
                            loaded: true,
                            children: [
                                {
                                    id: 'clientes-vetrade',
                                    name: 'Clientes',
                                    isFolder: true,
                                    level: 2,
                                    operationState: { 'R': 'allowed' },
                                    availableOperations: ['R'],
                                    lazyLoad: false,
                                    loaded: true,
                                    children: [
                                        {
                                            id: 'cliente-vetrade-1',
                                            name: 'Duro na Queda',
                                            isFolder: false,
                                            level: 3,
                                            operationState: { 'R': 'allowed' },
                                            availableOperations: ['R'],
                                            lazyLoad: false,
                                            loaded: true,
                                        }
                                    ]
                                }
                            ]
                        },
                        {
                            id: 'shocksat-domain',
                            name: 'Shocksat',
                            isFolder: true,
                            level: 1,
                            operationState: { 'C': 'denied', 'R': 'allowed' },
                            availableOperations: ['C', 'R', 'U', 'D'],
                            lazyLoad: false,
                            loaded: true,
                            children: [
                                {
                                    id: 'clientes-shocksat',
                                    name: 'Cliente',
                                    isFolder: true,
                                    level: 2,
                                    operationState: { 'R': 'allowed' },
                                    availableOperations: ['R'],
                                    lazyLoad: false,
                                    loaded: true,
                                    children: [
                                        {
                                            id: 'cliente-shocksat-1',
                                            name: 'Aghily',
                                            isFolder: false,
                                            level: 3,
                                            operationState: { 'R': 'allowed' },
                                            availableOperations: ['R'],
                                            lazyLoad: false,
                                            loaded: true,
                                        }
                                    ]
                                }
                            ]
                        }
                    ]
                }
            };

            // Operation handler must be provided to handle permission state changes
            const operationHandler = (node, operation) => {
                const currentState = node.operationState[operation] || 'unselected';
                let newState;
                
                switch (currentState) {
                    case 'unselected': newState = 'allowed'; break;
                    case 'allowed': newState = 'denied'; break;
                    case 'denied': newState = 'unselected'; break;
                    default: newState = 'unselected';
                }

                console.log(`Operation "${operation}" clicked on node "${node.name}" (ID: ${node.id})`);
                console.log(`Current state: ${currentState}, New state: ${newState}`);
                
                // Set the state for the clicked node
                node.operationState[operation] = newState;

                console.log(`State changed for node "${node.name}" (ID: ${node.id}) operation "${operation}": ${currentState} -> ${newState}`);

                // Example: propagate denied state to children for 'Read' operation
                if (node.isFolder && operation === 'R' && newState === 'denied') {
                    node.children.forEach(child => {
                        child.operationState[operation] = 'denied';
                        if (child.isFolder) {
                            // Recursively apply to descendants
                            child.children.forEach(grandChild => {
                                grandChild.operationState[operation] = 'denied';
                            });
                        }
                    });
                }

                // Example: update parent state based on children (simplified)
                if (node.parent) {
                    const siblingsState = node.parent.children.map(child => 
                        child.operationState[operation] || 'unselected'
                    );
                    const allSame = siblingsState.every(state => state === newState);
                    if (allSame) {
                        node.parent.operationState[operation] = newState;
                    }
                }
            };

            const childrenLoader =  async function(node, query) {
                console.log(query);
                console.log(node);
                
                // random id
                const randomId = Math.random().toString(36).substring(2, 15);

                // Example: Instance code directly adding children
                const child1 = new TreeNode('child1-' + randomId, 'Frum', {
                    isFolder: false,
                    lazyLoad: false,
                    availableOperations: ['C', 'R', 'U']
                });
                node.addChild(child1);

                // Add more children as needed
                const child2 = new TreeNode('child2-' + randomId, 'File 2.txt', {
                    isFolder: false,
                    lazyLoad: false,
                    availableOperations: ['R', 'U', 'D']
                });
                node.addChild(child2);

                // Add more children as needed
                const child3 = new TreeNode('child3-' + randomId, 'File 3.txt', {
                    isFolder: false,
                    lazyLoad: false,
                    availableOperations: ['R', 'U', 'D']
                });
                node.addChild(child3); // Corrected to add child3 instead of child2

                // Simulate loading children
                return new Promise((resolve) => {
                    setTimeout(() => {
                        resolve(node);
                    }, 100); // Simulate network delay
                });
            };

            // Initialize with the operation handler
            treeAction = new TreeAction({
                containerId: 'tree-container',
                initialData: initialTreeData,
                loadingText: 'Carregando...',
                operationHandler,
                childrenLoader,
            });

            // treeAction.getNodeById('child2').setState('R', 'allowed');
            // treeAction.render();

            // Example of adding a new operation type dynamically
            // setTimeout(() => {
            //     treeAction.addNewOperationType('E', 'Execute');
            // }, 3000);

            // Example of removing an operation type dynamically
            // setTimeout(() => {
            //     treeAction.removeOperationType('S');
            // }, 6000);
        });
    </script>

</body>
</html>
